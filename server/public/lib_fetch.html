<html>
<head></head>
<body>
	<script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
	<script>
	function getAlbums(library) {
		var albums = {};
		var albumsSorted = [];

		function addTitle(albums, track) {
			var meta = track.metadata;

			// Define a default string to use when values are unknown
			var unknownValue = '(Unknown)';
			// Cascading possible values for the album's artist:
			var actualArtist, actualAlbum;

			// Cycle through all albumartists first
			for(var i = 0, j = meta.albumartist.length; i < j; i++) {
				actualArtist = actualArtist || meta.albumartist[i];
			}
			// Then cycle through all artists
			for(var i = 0, j = meta.artist.length; i < j; i++) {
				actualArtist = actualArtist || meta.artist[i];
			}
			// If all else fails, assign unknown value
			actualArtist = actualArtist || unknownValue;

			// Set album title, or unknown value if it is not in the metadata
			actualAlbum = meta.album;

			// Concatenating artist and album name to have 'unique' identifiers
			var albumID = actualArtist + '::' + actualAlbum;
			// Create new object with albumID as index if it does not exist
			if(!albums[albumID]) {
				albums[albumID] = {
					name: actualAlbum,
					artist: actualArtist,
					year: meta.year,
					tracks: [],
				};
			}

			// Push the track onto the album with the given albumID
			albums[albumID].tracks.push(track);
		}

		// Cycle through all library entries and call addTitle on albums with each
		$.each(library, function(i, entry) {
			if(!entry.metadata) {
				// TODO write these to an array and notify the user of them
				console.log('No metadata for', entry);
				return;
			}

			addTitle(albums, entry);
		});

		// Sort all albums' tracks by track numbers,
		// and push each album onto the albumsSorted array to sort it afterwards
		$.each(albums, function(i, album) {
			album.tracks.sort(function(a, b) {
				var noA = a.metadata.track.no, noB = b.metadata.track.no;
				var titleA = a.metadata.title, titleB = b.metadata.title;

				// first by track number, then by title
				if(noA < noB) return -1;
				if(noA > noB) return 1;
				if(titleA > titleB) return -1;
				if(titleA < titleB) return 1;

				return 0;
			});

			albumsSorted.push(album);
		});

		// Sort the albumsSorted array
		albumsSorted.sort(function(a, b) {
			var artistA = a.artist.toLowerCase(), artistB = b.artist.toLowerCase();
			var albumA = a.name.toLowerCase(), albumB = b.name.toLowerCase();

			// first by artist, then by album name
			if(artistA > artistB) return 1;
			if(artistA < artistB) return -1;
			if(albumA > albumB) return 1;
			if(albumA < albumB) return -1;

			return 0;
		});

		// Return the sorted album array,
		// each album holding tracks sorted by title number
		return albumsSorted;
	}

	$.ajax('/library', { success: function(library) {
		console.log( getAlbums(library) );
	}});
	</script>
</body>
</html>